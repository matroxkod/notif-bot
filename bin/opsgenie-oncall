#!/usr/bin/env node

require('dotenv').config();
const https = require('https');
const axios = require('axios');

const today = new Date();
const wday = today.getDay();

if (wday == 0 || wday == 6) {
  // do not remind in slack at weekend
  process.exit();
}

const postSlack = (email, title, body) => {
  axios.post(process.env.SLACK_WORKFLOW_URL, {title: title, body: body, mentions: email}, {headers: {'Content-Type': 'application/json'} })
    .then(function (response) {
      console.log(response);
    })
    .catch(function (error) {
      console.log(error);
    });
}

axios.get('https://api.opsgenie.com/v2/schedules/b7c307b5-479c-46c5-a46c-173f0efe46f9/on-calls', {"headers": {"Authorization": 'GenieKey ' + process.env.OPSGENIE_KEY}})
  .then((response) => {
    let title = response.data.data._parent.name;
    let email = response.data.data.onCallParticipants[0].name;
    let body = "On-call today is "
    postSlack(email, title, body);
  })
  .catch(error => {
    console.log(error);
  });
